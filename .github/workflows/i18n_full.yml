name: i18n full-auto

# â†’ PR ìƒì„±ê¹Œì§€ í•˜ë ¤ë©´ ë‘ ê¶Œí•œ ëª¨ë‘ í•„ìš”
permissions:
  contents: write
  pull-requests: write

on:
  push:

concurrency:
  group: i18n-auto
  cancel-in-progress: true

jobs:
  auto_i18n:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true     # GITHUB_TOKEN ìœ ì§€

      - name: Run pre-diag
        id: diag
        run: |
          python scripts/i18n_diag.py > diag.json
          echo "report=$(cat diag.json)" >> "$GITHUB_OUTPUT"

      - name: Lint workflow YAML
        uses: frenck/action-yamllint@v1

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install --no-cache-dir beautifulsoup4 google-cloud-translate==3.*

      - name: Run auto-tag + translate
        run: |
          echo "::add-mask::${{ secrets.GCLOUD_PROJECT_ID }}"
          python scripts/i18n_full_auto.py
        env:
          GCLOUD_PROJECT_ID: ${{ secrets.GCLOUD_PROJECT_ID }}

      - name: Create or update PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: i18n/bot-update
          title: "â™»ï¸ i18n JSON ì—…ë°ì´íŠ¸"
          commit-message: "i18n: auto-update"
          labels: i18n, bot
          delete-branch: true

      - if: failure()
        uses: peter-evans/create-pull-request@v6
        with:
          branch: i18n/diag-report
          title: "ğŸš¨ i18n íŒŒì´í”„ë¼ì¸ ì§„ë‹¨ ë³´ê³ ì„œ"
          commit-message: "ci: add auto-diag report"
          body: |
            ### ìë™ ë¶„ì„ ê²°ê³¼
            ```json
            ${{ steps.diag.outputs.report }}
            ```
