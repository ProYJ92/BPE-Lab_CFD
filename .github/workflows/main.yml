# .github/workflows/site-ci-cd.yml
name: Web Site CI/CD Pipeline ğŸš€

########################
# 1. íŠ¸ë¦¬ê±° ì •ì˜
########################
on:
  # ì½”ë“œ ë³€ê²½   â†’  ë¹Œë“œÂ·í’ˆì§ˆê²€ì‚¬(+ PR ë¯¸ë¦¬ë³´ê¸°)
  push:
    branches: [main]
  pull_request:
    branches: [main]

  # ì£¼ 1íšŒ(ì¼ìš”ì¼ 03:00 KST) ë§í¬â€§API í—¬ìŠ¤ì²´í¬
  schedule:
    - cron: '0 18 * * 6'   # UTC 18 â†’ KST 03

  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:

########################
# 2. ê³µí†µ ì„¤ì •
########################
permissions:
  contents: read
  pages:    write     # ë°°í¬ìš©
  id-token: write     # OIDC ì„œëª…

concurrency:
  group: pages-main
  cancel-in-progress: false

env:
  BUILD_DIR: dist          # npm run build ê²°ê³¼ë¬¼ ê²½ë¡œ
  NODE_VERSION: '20'       # í•„ìš” ì‹œ 18/22 ë³€ê²½
  # API í‚¤ ì˜ˆì‹œ (Settings â†’ Secrets ì—ì„œ ì„¤ì •)
  # SAMPLE_API_KEY: ${{ secrets.SAMPLE_API_KEY }}

########################
# 3. ì¡ ì •ì˜
########################
jobs:

  # ---------- 3-1 Build & Test ----------
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'           # node_modules ìºì‹±

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # â”€â”€ ì½”ë“œ í’ˆì§ˆ (í•„ìš”ì—†ëŠ” í•­ëª©ì€ ì œê±°) â”€â”€
      - name: ğŸ§¹ ESLint / Prettier
        run: npm run lint        # ex) eslint && prettier --check .

      - name: ğŸ–Œï¸ Stylelint
        run: npm run stylelint   # ì„ íƒ

      - name: ğŸ“ Markdownlint
        run: npx markdownlint "**/*.md" || true

      - name: ğŸ”— Local link check
        uses: lycheeverse/lychee-action@v1
        with:
          args: --no-progress "src/**/*.html"

      # â”€â”€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ / API ëª¨í‚¹ í…ŒìŠ¤íŠ¸ â”€â”€
      - name: âœ… Unit tests
        run: npm test            # ex) jest / vitest

      # â”€â”€ í”„ë¡œë•ì…˜ ë¹Œë“œ â”€â”€
      - name: ğŸ› ï¸ Build
        run: npm run build       # ì˜ˆ: vite / astro / parcel ë“±

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.BUILD_DIR }}

  # ---------- 3-2 Preview (PR) ----------
  preview:
    if: github.event_name == 'pull_request'
    needs: build-test
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: ğŸš€ Deploy Preview
        id: deploy
        uses: actions/deploy-pages@v4
        with:
          preview: true          # PR ì „ìš© ì„ì‹œ URL ë°œê¸‰

  # ---------- 3-3 Production Deploy ----------
  deploy:
    if: github.event_name == 'push'
    needs: build-test
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

  # ---------- 3-4 Weekly Health Check ----------
  healthcheck:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Check external links & APIs
        uses: lycheeverse/lychee-action@v1
        with:
          args: --no-progress --verbose https://YOUR_USERNAME.github.io/YOUR_REPO
